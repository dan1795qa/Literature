function tma__profile__drawProfilePopup(){var e=document.querySelector(".tlk-userbar__popup-edit-profile");tildaMembers.upload||(tildaMembers.upload={}),e.addEventListener("click",function(){var i=tma__getProfileObjFromLS(),e=tma__profile__getFormEditProfileHtml(i);tma__drawPopup({id:"edit-profile",main:document.getElementById("app"),content:tma__translate(e,"userbar_dict"),closeBtns:[".tlk-popup__close-cancel"]}),tma__profile__addUploadEvents();var l=document.getElementById("form-change-profile"),e=l.querySelector(".tlk-popup__change-password"),t=l.querySelector(".tlk-popup__change-lang"),o=l.querySelector('button[type="submit"]'),s=!1;i.memberlogo_uuid&&(tildaMembers.upload.id=i.memberlogo_uuid,tildaMembers.upload.oldId=i.memberlogo_uuid),l.addEventListener("submit",function(e){e.preventDefault(),e.stopPropagation(),tma__resetErrorFields(l),tma__resetErrorRequest(l);e=tma__validationFormFields(l);0<e.length?tma__showErrorFields(l,e,"userbar_dict"):((e=tma__serializeArray(l)).projectid=i.projectid,e.token=i.token,e.tzoffset=(new Date).getTimezoneOffset(),tildaMembers.upload&&tildaMembers.upload.id&&(e.memberlogo=tildaMembers.upload.id),tildaMembers.userLang!==t.value&&(e.lang=t.value,s=!0),e=JSON.stringify(e),tma__request("/api/editprofile/",e,o,function(e){var t;"ok"===e.status&&"object"==typeof e.data?(t=e.data,tildaMembers.upload.id="",i.name=t.name,i.login=t.login,t.memberlogo_uuid?(i.memberlogo=t.memberlogo,i.memberlogo_uuid=t.memberlogo_uuid):(i.memberlogo="",i.memberlogo_uuid=""),tma__showSuccessRequest(l,tma__translate("{{edit_profile_success_text}}","userbar_dict")),t="tilda_members_profile"+i.projectid,localStorage.setItem(t,JSON.stringify(i)),localStorage.setItem(t+"_timestamp",Math.floor(Date.now()/1e3)),s?setTimeout(function(){window.location.reload()},1e3):tma__userbar__updateDataProfile()):tma__showErrorRequest(l,e.code,"userbar_dict","edit_profile")}))}),e.addEventListener("click",function(){var e=tma__profile__getFormChangePasswordHtml();tma__drawPopup({id:"change-password",main:document.getElementById("app"),content:tma__translate(e,"userbar_dict"),closeBtns:[".tlk-popup__close-cancel"]});var t=document.getElementById("change-password"),l=document.getElementById("form-change-password"),o=l.querySelector('button[type="submit"]');tma__profile__addButtonShowHidePasswordEvents(l),l.addEventListener("submit",function(e){e.preventDefault(),e.stopPropagation(),tma__resetErrorFields(l),tma__resetErrorRequest(l);e=tma__validationFormFields(l);0<e.length?tma__showErrorFields(l,e,"userbar_dict"):((e=tma__serializeArray(l)).projectid=i.projectid,e.token=i.token,e.tzoffset=(new Date).getTimezoneOffset(),e=JSON.stringify(e),tma__request("/api/editpassword/",e,o,function(e){"ok"===e.status?(tma__showSuccessRequest(l,tma__translate("{{change_password_success_text}}","userbar_dict")),setTimeout(function(){tma__closePopup(t)},1e3)):tma__showErrorRequest(l,e.code,"userbar_dict","change_password")}))})})})}function tma__profile__addUploadEvents(){var r=document.querySelector(".tlk-popup__close-save"),a=document.querySelector(".tlk-upload"),n=a.querySelector('input[type="file"]'),d=a.querySelector(".tlk-upload__button"),_=a.querySelector(".tlk-upload__error"),p=a.querySelector(".tlk-upload__preview"),e=a.querySelector(".tlk-upload__reset"),c=["image/png","image/jpg","image/jpeg","image/gif"];function u(){tildaMembers.upload.id="",n.value="",p.innerHTML=""}e&&e.addEventListener("click",u),n.addEventListener("change",function(){var e=n.files[0],t=e.type,l=parseFloat((+e.size/Math.pow(1024,2)).toFixed(4)),o=!1;_.classList.remove("tlk-upload__error_show"),_.innerHTML="";for(var i=0;i<c.length;i++)if(c[i]===t){o=!0;break}if(!o)return _.innerHTML=tma__translate("{{field_file_type}}","userbar_dict"),_.classList.add("tlk-upload__error_show"),void(n.value="");if(2<l)return _.innerHTML=tma__translate("{{field_file_size}}","userbar_dict"),_.classList.add("tlk-upload__error_show"),void(n.value="");var s=tma__getProfileObjFromLS(),l=new FormData;l.append("projectid",s.projectid),l.append("token",s.token),l.append("file",e),l.append("tzoffset",(new Date).getTimezoneOffset()),r.disabled=!0,tma__request("/api/uploadmemberlogo/",l,d,function(e){"ok"===e.status&&"object"==typeof e.data?(tildaMembers.upload.id=e.data.uuid,p.innerHTML='<img src="'+e.data.cdnurl+'"><button type="button" class="tlk-upload__reset tlk-btn_reset"></button>',a.querySelector(".tlk-upload__reset").addEventListener("click",u)):(_.innerHTML=tma__translate("{{upload_logo_"+e.code+"}}","userbar_dict"),_.classList.add("tlk-upload__error_show")),r.disabled=!1},!0)})}function tma__profile__addButtonShowHidePasswordEvents(){for(var e=document.querySelectorAll(".tlk-password-toggle"),t=0;t<e.length;t++)e[t].addEventListener("click",function(){var e=this,t=e.parentNode.querySelector("input");e.classList.toggle("tlk-password-toggle__show"),e.classList.contains("tlk-password-toggle__show")?t.setAttribute("type","text"):t.setAttribute("type","password")})}function tma__profile__getFormEditProfileHtml(e){var t="";return t+='<div class="tlk-popup__title" data-field="tlk-title">{{form_edit_profile_title}}</div>',t+='<form method="post" id="form-change-profile" action="/">',t+='<div class="tlk-popup__form-wrap">',t+='<div class="tlk-popup__item">',t+='<div class="tlk-input-title" data-field="tlk-text">{{form_edit_profile_field_name}}</div>',t+='<input type="text" name="name" placeholder="{{form_edit_profile_placeholder_name}}" class="tlk-input" value="'+e.name+'" required>',t+='<div class="tlk-input-error"></div>',t+="</div>",e.allowEditProfile&&(t+='<div class="tlk-popup__item">',t+='<div class="tlk-input-title">{{form_edit_profile_field_email}}</div>',t+='<input type="text" name="login" placeholder="{{form_edit_profile_placeholder_email}}" class="tlk-input" value="'+e.login+'" required>',t+='<div class="tlk-input-error"></div>',t+="</div>"),t+='<div class="tlk-popup__item">',t+='<div class="tlk-input-title" data-field="tlk-text">{{form_edit_profile_field_image}}</div>',t+='<div class="tlk-upload">',t+='<label class="tlk-upload__button" for="image-file">{{form_edit_profile_btn_image}}<span class="tlk-loadicon"></span></label>',t+='<input type="file" accept="image/png, image/jpg, image/jpeg, image/gif" id="image-file">',t+='<div class="tlk-upload__preview">',e.memberlogo&&(t+='<img src="'+e.memberlogo+'">',t+='<button type="button" class="tlk-upload__reset tlk-btn_reset"></button>'),t+="</div>",t+='<div class="tlk-upload__error"></div>',t+="</div>",t+="</div>",t+='<div class="tlk-popup__item">',t+='<div class="tlk-input-title" data-field="tlk-text">{{form_edit_profile_field_lang}}</div>',t+='<div class="tlk-select">',t+='<select type="button" class="tlk-popup__change-lang">',t+='<option value="RU"'+("RU"===tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_ru}}</option>",t+='<option value="EN"'+("EN"===tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_en}}</option>",t+='<option value="DE"'+("DE"===tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_de}}</option>",t+="</select>",t+="</div>",t+="</div>",t+='<div class="tlk-popup__item">',t+='<button type="button" class="tlk-popup__change-password tlk-btn_reset">{{form_edit_profile_btn_change_password}}</button>',t+="</div>",t+="</div>",t+='<div class="tlk-input-error tlk-input-error_all"></div>',t+='<div class="tlk-popup__buttons">',t+='<button type="button" class="tlk-popup__close-cancel tlk-popup__button tlk-btn tlk-btn_white tlk-btn_reset">{{form_edit_profile_btn_cancel}}</button>',t+='<button type="submit" class="tlk-popup__close-save tlk-popup__button tlk-btn tlk-btn_gray tlk-btn_reset">{{form_edit_profile_btn_save}}<span class="tlk-loadicon"></span></button>',t+="</div>",t+="</form>"}function tma__profile__getFormChangePasswordHtml(){return'<div class="tlk-popup__title" data-field="tlk-title">{{form_change_password_title}}</div><form method="post" id="form-change-password" action="/"><div class="tlk-popup__form-wrap"><div class="tlk-popup__item"><div class="tlk-input-title" data-field="tlk-text">{{form_change_password_field_old_password}}</div><input type="password" name="password" class="tlk-input" required><div class="tlk-input-error"></div><div class="tlk-password-toggle"><svg class="tlk-password-toggle__visible-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 21.5 12.9" style="enable-background:new 0 0 21.5 12.9;" xml:space="preserve"><path class="st0" d="M0.8,6.5c0,0,3.5,4.8,10,4.8s10-4.8,10-4.8s-3.5-4.8-10-4.8S0.8,6.5,0.8,6.5z" fill="none" stroke="#777777" stroke-miterlimit="10"></path><circle class="st1" cx="10.8" cy="6.5" r="2.5" fill="#777777" stroke="#777777" stroke-miterlimit="10"></circle></svg><svg class="tlk-password-toggle__hidden-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 21.5 12.9" style="enable-background:new 0 0 21.5 12.9;" xml:space="preserve"><path class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" d="M0.8,6.5c0,0,3.5,4.8,10,4.8s10-4.8,10-4.8s-3.5-4.8-10-4.8S0.8,6.5,0.8,6.5z"></path><circle class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" cx="10.8" cy="6.5" r="2.5"></circle><line class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" x1="4.8" y1="12.5" x2="16.8" y2="0.5"></line></svg></div></div><div class="tlk-popup__item"><div class="tlk-input-title" data-field="tlk-text">{{form_change_password_field_new_password}}</div><input type="password" name="newpassword" class="tlk-input" required><div class="tlk-input-error"></div><div class="tlk-password-toggle"><svg class="tlk-password-toggle__visible-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 21.5 12.9" style="enable-background:new 0 0 21.5 12.9;" xml:space="preserve"><path class="st0" d="M0.8,6.5c0,0,3.5,4.8,10,4.8s10-4.8,10-4.8s-3.5-4.8-10-4.8S0.8,6.5,0.8,6.5z" fill="none" stroke="#777777" stroke-miterlimit="10"></path><circle class="st1" cx="10.8" cy="6.5" r="2.5" fill="#777777" stroke="#777777" stroke-miterlimit="10"></circle></svg><svg class="tlk-password-toggle__hidden-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 21.5 12.9" style="enable-background:new 0 0 21.5 12.9;" xml:space="preserve"><path class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" d="M0.8,6.5c0,0,3.5,4.8,10,4.8s10-4.8,10-4.8s-3.5-4.8-10-4.8S0.8,6.5,0.8,6.5z"></path><circle class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" cx="10.8" cy="6.5" r="2.5"></circle><line class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" x1="4.8" y1="12.5" x2="16.8" y2="0.5"></line></svg></div></div></div><div class="tlk-input-error tlk-input-error_all"></div><div class="tlk-popup__buttons"><button type="button" class="tlk-popup__close-cancel tlk-popup__button tlk-btn tlk-btn_white tlk-btn_reset">{{form_change_password_btn_cancel}}</button><button type="submit" class="tlk-popup__close-save tlk-popup__button tlk-btn tlk-btn_gray tlk-btn_reset">{{form_change_password_btn_save}}<span class="tlk-loadicon"></span></button></div></form>'}
